<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Private Lottery — Zama FHEVM</title>
  <style>
    :root{
      --bg:#0b0f16;
      --card:#0f1522;
      --muted:#8ca0b3;
      --text:#e8f0ff;
      --accent:#7dd3fc;
      --accent-2:#60a5fa;
      --ok:#34d399;
      --warn:#f59e0b;
      --err:#ef4444;
      --bd:1px solid rgba(255,255,255,.08);
      --shadow1:0 8px 40px rgba(0,0,0,.35);
      --glass:rgba(17,24,39,.55);
      --glass-bd:1px solid rgba(255,255,255,.07);
      --br:18px;
    }
    [data-theme="light"]{
      --bg:#f6f8fc;
      --card:#ffffffcc;
      --text:#0b1220;
      --muted:#4a6074;
      --accent:#0369a1;
      --accent-2:#0ea5e9;
      --bd:1px solid rgba(0,0,0,.06);
      --glass:rgba(255,255,255,.7);
      --glass-bd:1px solid rgba(0,0,0,.06);
      --shadow1:0 10px 35px rgba(7,30,60,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:15.5px/1.45 Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 10% -10%, #1b2555 0%, transparent 60%),
        radial-gradient(900px 600px at 90% 0%, #0e6aa8 0%, transparent 60%),
        var(--bg);
      background-attachment: fixed;
    }
    .wrap{max-width:1100px;margin:26px auto;padding:0 16px}
    /* Header */
    header.hero{
      display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin-bottom:18px
    }
    .brand{
      display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;
      background:var(--glass);backdrop-filter: blur(10px); border:var(--glass-bd);
      box-shadow:var(--shadow1)
    }
    .logo{font-weight:900;letter-spacing:.2px}
    .logo span{color:var(--accent-2)}
    .badge{background:var(--glass);border:var(--glass-bd);backdrop-filter:blur(10px);
      border-radius:999px;padding:8px 12px;color:var(--muted);font-size:12px}
    .spacer{flex:1}
    .btn{
      border:var(--bd); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      color:var(--text); padding:10px 14px;border-radius:12px;cursor:pointer;
      transition:.2s; box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), var(--shadow1)
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg, var(--accent-2), var(--accent)); color:#06131e;border:none}
    .btn.ghost{background:var(--glass);backdrop-filter: blur(8px);border:var(--glass-bd)}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .btn[disabled]{opacity:.6;cursor:not-allowed;filter:grayscale(.4)}
    /* Grid cards */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{
      grid-column: span 12;
      background:var(--glass); backdrop-filter: blur(10px); border:var(--glass-bd);
      border-radius:var(--br); box-shadow:var(--shadow1); padding:18px
    }
    @media (min-width:880px){
      .w6{grid-column: span 6}
      .w5{grid-column: span 5}
      .w7{grid-column: span 7}
    }
    h2{margin:0 0 10px 0;font-size:16px}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-weight:600}
    input{
      width:100%; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:var(--glass-bd); color:var(--text); border-radius:12px; padding:11px 12px; outline:none
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:var(--glass-bd)}
    .stat{padding:10px;border-radius:12px;border:1px dashed rgba(255,255,255,.15)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    /* Toast */
    .toast{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast .t{
      background:var(--glass);border:var(--glass-bd);backdrop-filter:blur(10px);border-radius:12px;
      padding:10px 12px;box-shadow:var(--shadow1);font-size:13px
    }
    /* Toggle */
    .toggle{display:inline-flex;gap:8px;align-items:center}
    .switch{position:relative;width:44px;height:24px;background:rgba(255,255,255,.12);border-radius:999px;cursor:pointer;border:var(--glass-bd)}
    .switch::after{content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:white;transition:.2s}
    [data-theme="light"] .switch{background:#bfe0fb}
    [data-theme="light"] .switch::after{transform:translateX(20px)}
    .hint{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:8px 0 4px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div class="brand">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3l7.794 4.5v9L12 21 4.206 16.5v-9L12 3z" stroke="currentColor" stroke-width="1.4"/></svg>
        <div class="logo">Private <span>Lottery</span></div>
      </div>
      <span id="netBadge" class="badge">Network: —</span>
      <span id="ctrBadge" class="badge">Contract: —</span>
      <span class="spacer"></span>
      <div class="toggle">
        <div class="hint">Theme</div>
        <div id="themeSwitch" class="switch" title="Toggle theme"></div>
      </div>
      <button id="connectBtn" class="btn primary">Connect Wallet</button>
    </header>

    <section class="grid">
      <!-- Join -->
      <div class="card w6">
        <h2>Join round</h2>
        <div class="row">
          <div style="flex:1;min-width:220px">
            <label>Round ID</label>
            <input id="joinRound" placeholder="e.g. 1">
          </div>
          <div style="flex:1;min-width:220px">
            <label>My secret number (uint16)</label>
            <input id="secretNum" type="number" min="0" max="65535" placeholder="e.g. 777">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="joinBtn" class="btn">Encrypt & Join</button>
          <button id="joinedBtn" class="btn ghost">Check joined?</button>
          <span id="joinStatus" class="muted"></span>
        </div>
        <div id="joinTx" class="muted" style="margin-top:6px"></div>
        <div class="hr"></div>
        <div class="hint">Your number is encrypted in-browser via Zama Relayer SDK and sent as ciphertext; the contract never sees your plaintext.</div>
      </div>

      <!-- Admin -->
      <div class="card w6">
        <h2>Admin</h2>
        <div class="row">
          <div style="flex:1;min-width:220px">
            <label>Round ID</label>
            <input id="adminRound" placeholder="e.g. 1">
          </div>
          <div class="row" style="gap:8px;align-items:flex-end">
            <button id="startBtn" class="btn">Start round</button>
            <button id="drawBtn" class="btn">Draw winner</button>
          </div>
        </div>
        <div id="adminStatus" class="muted" style="margin-top:8px"></div>
        <div class="hr"></div>
        <div class="hint">In production, replace demo randomness with VRF or an audited randomness source.</div>
      </div>

      <!-- State -->
      <div class="card w7">
        <h2>Read state</h2>
        <div class="row">
          <div style="flex:1;min-width:220px">
            <label>Round ID</label>
            <input id="readRound" placeholder="e.g. 1">
          </div>
          <button id="countBtn" class="btn">Players count</button>
          <button id="winnerBtn" class="btn ghost">Winner</button>
        </div>
        <div class="row" style="margin-top:10px">
          <span class="pill">open: <strong id="isOpen">—</strong></span>
          <span class="pill">players: <strong id="playersCount">—</strong></span>
          <span class="pill">winner: <strong id="winnerAddr">—</strong></span>
        </div>
      </div>

      <!-- Tips -->
      <div class="card w5">
        <h2>How it works</h2>
        <div class="stat">
          • Every participant encrypts a uint16 locally → contract stores only ciphertext.<br/>
          • Winner is chosen randomly among addresses; numbers are never revealed.
        </div>
        <div class="hr"></div>
        <div class="hint">You can re-use the same design to build private raffles, sealed-bid registrations, and more.</div>
      </div>
    </section>
  </div>

  <!-- Toasts -->
  <div id="toaster" class="toast" aria-live="polite"></div>

<script type="module">
  import { BrowserProvider, Contract, getAddress } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm";
  import { initSDK, createInstance, SepoliaConfig } from "https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js";

  // ====== CONFIG ======
  const CONFIG = {
    NETWORK_NAME: "Sepolia",
    CHAIN_ID_HEX: "0xaa36a7",
    CONTRACT_ADDRESS: "0xf5D1A768fd8c54E2230eFf26454D6acfa427021B", // <— put your deployed address
    RELAYER_URL: "https://relayer.testnet.zama.cloud"
  };

  const ABI = [
    {"type":"function","name":"startRound","stateMutability":"nonpayable","inputs":[{"name":"roundId","type":"uint256"}],"outputs":[]},
    {"type":"function","name":"draw","stateMutability":"nonpayable","inputs":[{"name":"roundId","type":"uint256"}],"outputs":[]},
    {"type":"function","name":"join","stateMutability":"nonpayable","inputs":[{"name":"roundId","type":"uint256"},{"name":"pickExt","type":"bytes32"},{"name":"attestation","type":"bytes"}],"outputs":[]},
    {"type":"function","name":"isOpen","stateMutability":"view","inputs":[{"name":"roundId","type":"uint256"}],"outputs":[{"type":"bool"}]},
    {"type":"function","name":"playersCount","stateMutability":"view","inputs":[{"name":"roundId","type":"uint256"}],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"winnerOf","stateMutability":"view","inputs":[{"name":"roundId","type":"uint256"}],"outputs":[{"type":"address"}]},
    {"type":"function","name":"hasJoined","stateMutability":"view","inputs":[{"name":"roundId","type":"uint256"},{"name":"user","type":"address"}],"outputs":[{"type":"bool"}]}
  ];

  // ====== helpers ======
  const $ = s => document.querySelector(s);
  const set = (sel, v) => { const el=$(sel); if(el) el.textContent=v; };
  const short = a => a ? a.slice(0,6)+"…"+a.slice(-4) : "—";
  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
  function toast(msg, tone=""){ const t=document.createElement('div'); t.className='t'; t.textContent=msg; if(tone) t.style.borderLeft=`4px solid ${tone}`; $('#toaster').appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(6px)'; setTimeout(()=>t.remove(),320); }, 2600); }

  // Header badges
  set('#netBadge', `Network: ${CONFIG.NETWORK_NAME}`);
  set('#ctrBadge', `Contract: ${short(CONFIG.CONTRACT_ADDRESS)}`);

  // Theme toggle
  const themeSwitch = $('#themeSwitch');
  const savedTheme = localStorage.getItem('pl_theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  themeSwitch.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme')==='light'?'dark':'light';
    document.documentElement.setAttribute('data-theme', cur);
    localStorage.setItem('pl_theme', cur);
  });

  // ====== state ======
  let provider, signer, address, contract, relayer;

  async function connect(){
    if(!window.ethereum) throw new Error('Install MetaMask-compatible wallet');
    provider = new BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    const net = await provider.getNetwork();
    if(net.chainId !== 11155111n){
      await provider.send('wallet_switchEthereumChain', [{ chainId: CONFIG.CHAIN_ID_HEX }]);
    }
    signer   = await provider.getSigner();
    address  = await signer.getAddress();
    contract = new Contract(getAddress(CONFIG.CONTRACT_ADDRESS), ABI, signer);

    await initSDK();
    relayer = await createInstance({
      ...SepoliaConfig, relayerUrl: CONFIG.RELAYER_URL, network: window.ethereum, debug: true
    });

    $('#connectBtn').textContent = short(address);
    toast('Wallet connected', '#22d3ee');
  }

  $('#connectBtn').addEventListener('click', ()=>connect().catch(e=>toast(e.message || String(e), '#ef4444')));

  // ====== encryption (uint16) ======
  async function encrypt16For(contractAddr, userAddr, value){
    const enc = relayer.createEncryptedInput(getAddress(contractAddr), getAddress(userAddr));
    enc.add16(BigInt(value));
    const { handles, inputProof } = await enc.encrypt();
    if(!handles?.length || !inputProof) throw new Error('Encryption failed');
    const att = typeof inputProof === 'string' ? (inputProof.startsWith('0x')?inputProof:'0x'+inputProof)
            : '0x'+Array.from(inputProof, b=>b.toString(16).padStart(2,'0')).join('');
    return { handle: handles[0], att };
  }

  // ====== UI refs ======
  const joinRound = $('#joinRound'), secretNum = $('#secretNum');
  const joinBtn = $('#joinBtn'), joinedBtn=$('#joinedBtn');
  const joinStatus = $('#joinStatus'), joinTx=$('#joinTx');

  const adminRound = $('#adminRound'), startBtn=$('#startBtn'), drawBtn=$('#drawBtn');
  const adminStatus = $('#adminStatus');

  const readRound = $('#readRound'), countBtn=$('#countBtn'), winnerBtn=$('#winnerBtn');
  const isOpen = $('#isOpen'), playersCount=$('#playersCount'), winnerAddr=$('#winnerAddr');

  // ====== JOIN ======
  joinBtn.addEventListener('click', async ()=>{
    try{
      if(!signer) await connect();
      joinBtn.disabled = true;
      const rid = parseInt(joinRound.value || '0');
      const num = parseInt(secretNum.value || '0');
      set('#joinStatus','Encrypting…');
      const { handle, att } = await encrypt16For(CONFIG.CONTRACT_ADDRESS, address, num);
      toast('Encrypted locally', '#7dd3fc');
      set('#joinStatus','Sending…');
      const tx = await contract.join(rid, handle, att);
      joinTx.textContent = 'tx: ' + tx.hash;
      await tx.wait();
      set('#joinStatus','Joined!');
      toast('Joined round', '#34d399');
    }catch(e){
      console.error(e);
      set('#joinStatus','Error');
      toast(e.reason || e.message || String(e), '#ef4444');
    }finally{ joinBtn.disabled = false; }
  });

  joinedBtn.addEventListener('click', async ()=>{
    try{
      if(!signer) await connect();
      const rid = parseInt(joinRound.value || '0');
      const ok = await contract.hasJoined(rid, address);
      set('#joinStatus', ok ? 'Already joined' : 'Not joined');
      toast(ok ? 'Already joined' : 'Not joined', ok?'#34d399':'#f59e0b');
    }catch(e){ toast(e.message || String(e), '#ef4444'); }
  });

  // ====== ADMIN ======
  startBtn.addEventListener('click', async ()=>{
    try{
      if(!signer) await connect();
      startBtn.disabled = true;
      const rid = parseInt(adminRound.value || '0');
      set('#adminStatus','Starting…');
      const tx = await contract.startRound(rid);
      await tx.wait();
      set('#adminStatus','Round opened');
      toast('Round opened', '#22d3ee');
    }catch(e){ toast(e.reason || e.message || String(e), '#ef4444'); }
    finally{ startBtn.disabled = false; }
  });

  drawBtn.addEventListener('click', async ()=>{
    try{
      if(!signer) await connect();
      drawBtn.disabled = true;
      const rid = parseInt(adminRound.value || '0');
      set('#adminStatus','Drawing…');
      const tx = await contract.draw(rid);
      await tx.wait();
      set('#adminStatus','Winner drawn');
      toast('Winner drawn', '#34d399');
    }catch(e){ toast(e.reason || e.message || String(e), '#ef4444'); }
    finally{ drawBtn.disabled = false; }
  });

  // ====== READ ======
  countBtn.addEventListener('click', async ()=>{
    try{
      if(!provider) await connect();
      const rid = parseInt(readRound.value || '0');
      const open = await contract.isOpen(rid);
      const cnt  = await contract.playersCount(rid);
      isOpen.textContent = open ? 'true' : 'false';
      playersCount.textContent = String(cnt);
      toast(`open: ${open} • players: ${cnt}`, '#7dd3fc');
    }catch(e){ toast(e.message || String(e), '#ef4444'); }
  });

  winnerBtn.addEventListener('click', async ()=>{
    try{
      if(!provider) await connect();
      const rid = parseInt(readRound.value || '0');
      const w = await contract.winnerOf(rid);
      winnerAddr.textContent = w;
      toast(`winner: ${short(w)}`, '#a78bfa');
    }catch(e){ winnerAddr.textContent='—'; toast(e.message || String(e), '#ef4444'); }
  });

  // small entrance delight
  (async ()=>{ await sleep(250); toast('Welcome to Private Lottery', '#22d3ee'); })();
</script>
</body>
</html>
